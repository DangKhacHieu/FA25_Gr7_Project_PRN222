@page
@model FA25_G7_PRN222_Web_ban_dien_thoai_Razor_Pages.Pages.Carts.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "Giỏ hàng của bạn";
}

<div class="container my-4">
    <h3 class="fw-bold mb-4">🛒 Giỏ hàng của bạn</h3>

    <div class="toast-container position-fixed top-2 end-0 p-3" style="z-index:10800;"></div>

    @if (Model.UserCart == null || Model.UserCart.CartItems.Count == 0)
    {
        <div class="alert alert-info text-center">Giỏ hàng của bạn đang trống.</div>
    }
    else
    {
        @Html.AntiForgeryToken()
        <div class="card shadow-sm mb-4">
            <div class="card-body" id="cart-items-list">
                @foreach (var item in Model.UserCart.CartItems)
                {
                    <div class="row align-items-center border-bottom py-3" data-cartitem="@item.CartItemId">
                        <div class="col-2">
                            <img src="@item.Product.ImageURL"
                                 class="img-fluid rounded"
                                 alt="@item.Product.ProductName" />
                        </div>

                        <div class="col-4">
                            <h6 class="fw-bold mb-1">@item.Product.ProductName</h6>
                            <p class="text-muted small mb-1">
                                RAM: @item.Product.Ram | ROM: @item.Product.Rom
                                <br /><span class="text-muted small">Tồn kho: @item.Product.Quantity_Product</span>
                            </p>
                            <p class="fw-bold text-danger">@item.Product.Price?.ToString("N0") đ</p>
                        </div>

                        <div class="col-3 d-flex align-items-center">
                            <form class="d-flex align-items-center" onsubmit="return false;">
                                <input type="hidden" name="CartItemId" value="@item.CartItemId" />

                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="changeQty(this, -1)">
                                        -
                                </button>

                                <input type="number" value="@item.Quantity"
                                       class="form-control text-center mx-2 visible-qty"
                                       style="width:90px"
                                       data-id="@item.CartItemId"
                                       data-quantity="@item.Quantity"
                                       data-max="@item.Product.Quantity_Product"
                                       onchange="sendUpdate(this)" />

                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="changeQty(this, +1)">
                                    +
                                </button>
                            </form>
                        </div>

                        <div class="col-2 text-end fw-bold subtotal">@item.SubTotal.ToString("N0") đ</div>
                        <div class="col-1 text-end">
                            <div class="col-1 text-end">
                                <form method="post" asp-page="Remove" class="form-delete">
                                    <input type="hidden" name="CartItemId" value="@item.CartItemId" />
                                    <input type="hidden" name="CartId" value="@item.CartId" />
                                    <button type="submit" class="btn btn-link text-danger p-0">🗑️</button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="fw-bold">Tổng tiền:</span>
                    <span class="fw-bold text-danger" id="cart-total">
                        @Model.UserCart.TotalPrice.ToString("N0") đ
                    </span>
                </div>

                <button class="btn btn-warning w-100 fw-bold py-2">Đặt hàng</button>
            </div>
        </div>
    }
</div>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">🗑️ Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="btn-confirm-delete">Xóa</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let formToDelete = null;
        const deleteModalElement = document.getElementById('deleteConfirmModal');
        const deleteModal = new bootstrap.Modal(deleteModalElement);
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');

        document.querySelectorAll('.form-delete').forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                formToDelete = event.target; 
                deleteModal.show(); 
            });
        });

        btnConfirmDelete.addEventListener('click', async function () {
            if (formToDelete) {
                const cartItemId = formToDelete.querySelector('input[name="CartItemId"]').value;
                const data = { CartItemId: cartItemId };

                await JsonTask("/Carts/Remove", data, formToDelete);

                deleteModal.hide();
                formToDelete = null;
            }
        });

        deleteModalElement.addEventListener('hidden.bs.modal', function () {
            if (formToDelete) {
                formToDelete = null;
            }
        });

        async function JsonTask(url, data, contextElement) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-Requested-With": "XMLHttpRequest",
                        "RequestVerificationToken": token
                    },
                    body: new URLSearchParams(data)
                });

                if (!response.ok) {
                    throw new Error('Lỗi từ máy chủ: ' + response.status);
                }

                const result = await response.json();

                if (result.success === false && result.message) {
                    showGlobalToast(result.message, 'danger');

                    // Nếu lỗi hết hạn, tải lại trang
                    if (result.message.includes("hết hạn")) {
                        location.reload();
                    }
                }

            } catch (err) {
                console.error("Lỗi JsonTask:", err);
                showGlobalToast("⚠️ Lỗi kết nối máy chủ.", "danger");
            }
        }

        // HÀM GỬI CẬP NHẬT SỐ LƯỢNG
        async function sendUpdate(input) {
            let baseQuantity = parseInt(input.dataset.quantity);
            let quantity = input.valueAsNumber;
            const max = parseInt(input.dataset.max) || 9999;
            const cartItemId = input.dataset.id;

            // 1. Kiểm tra NaN hoặc số âm
            // if (Number.isNaN(quantity) || quantity < 1) {
            //     showGlobalToast("Số lượng phải là số dương.", "danger");
            //     input.value = baseQuantity; Trả về giá trị cũ
            //     return;
            // }

            // 2. Kiểm tra vượt quá tồn kho
            // if (quantity > max) {
            //     showGlobalToast("Số lượng vượt quá tồn kho (" + max + ").", "warning");
            //     input.value = max; 
            //     quantity = max;
            // }

            if (quantity == baseQuantity) {
                return;
            }

            input.dataset.quantity = quantity;

            const data = {
                CartItemId: cartItemId,
                Quantity: quantity
            };

            await JsonTask("/Carts/Update", data, input);
        }

        // HÀM CHO NÚT (+)/(-)
        function changeQty(btn, delta) {
            const input = btn.parentElement.querySelector(".visible-qty");
            let value = parseInt(input.value) || 1;

            value += delta;
            input.value = value;

            sendUpdate(input);
        }
    </script>
}